# 中小企業向け 経営分析ダッシュボード

本リポジトリは、日本の中小企業向けに PL/BS/人員データを可視化する Streamlit ダッシュボード MVP です。添付の公的統計 CSV を読み込み、産業大分類コードと業種中分類の選択だけで最新 KPI・推移・比較を確認できます。

## セットアップ

1. Python 3.11 以上を用意します。
2. 依存パッケージをインストールします。

```bash
pip install -r requirements.txt
```

3. `/mnt/data/産業構造マップ_中小企業経営分析_推移　bs pl　従業員数.csv` を参照できる環境で Streamlit を起動します。

```bash
streamlit run app.py
```

## 主な機能

- **自動フィルタリング**: 産業大分類コードと業種中分類を選ぶだけで対象データが自動抽出されます。URL クエリ（`?maj=...&mid=...&y1=...&y2=...`）で共有も可能です。
- **KPI カード**: 売上高、営業利益、EBITDA など 8 指標をカード表示し、前年対比バッジとスパークラインを併記します。
- **主要グラフ 6 点**: 売上・利益、利益率、BS 構成比、EBITDA vs 利払、労働生産性 vs 分配率、DuPont 分解を Plotly で描画し、PNG ダウンロードにも対応します。
- **比較ライン**: 同産業大分類平均・全体平均を灰色系ラインで併記し、自社との差異を一瞥できます。
- **データ更新**: 右上のアップローダから CSV を取り込み、DuckDB (`app.duckdb`) に UPSERT します。取り込み後は即座に再描画されます。
- **データテーブル**: streamlit-aggrid で年次×KPI 一覧を表示し、CSV ダウンロードが可能です。

## データ仕様

- 入力: `/mnt/data/産業構造マップ_中小企業経営分析_推移　bs pl　従業員数.csv`
- 文字コード: `cp932`（検出できない場合は `utf-8-sig` にフォールバック）
- 主キー: `集計年`, `産業大分類コード`, `産業大分類名`, `業種中分類コード`, `業種中分類名`, `集計形式`
- 数値列は pandas にて `to_numeric(errors="coerce")` で変換し、欠損値は計算から除外します。

## KPI 定義

| 区分 | 指標 | 定義 |
| --- | --- | --- |
| 成長性 | 売上高 YoY | `(当年売上高 − 前年売上高) / 前年売上高` |
|  | 営業利益 YoY | `(当年営業利益 − 前年営業利益) / 前年営業利益` |
|  | 売上高 CAGR (3 年) | `((売上高_t / 売上高_{t-3}) ** (1/3)) − 1` |
| 収益性 | 総利益率 | `売上総利益 ÷ 売上高` |
|  | 営業利益率 | `営業利益 ÷ 売上高` |
|  | 経常利益率 | `経常利益 ÷ 売上高` |
|  | EBITDA | `営業利益 + 減価償却費合計`（「減価償却費」重複列は合算） |
|  | Interest Coverage | `EBITDA ÷ 支払利息・割引料` |
| 安全性 | 自己資本比率 | `純資産 ÷ 資産` |
|  | 有利子負債依存度 | `(短期借入金 + 長期借入金 + 社債) ÷ 資産` |
| 効率性 | 総資本回転率 | `売上高 ÷ 資産` |
| 生産性 | 労働生産性 | `付加価値額 ÷ FTE`（FTE = 常用雇用者 + 正社員以外換算 + 派遣等合計） |
|  | 労働分配率 | `人件費 ÷ 付加価値額` |
| DuPont | ROE | `税引後当期純利益 ÷ 純資産` |
|  | 分解要素 | `当期純利益率 × 総資産回転率 × レバレッジ（資産/純資産）` |

分母が 0 または欠損の場合は指標を `—` 表示とし、カードのツールチップに必要列が不足している旨を表示します。

## データ更新フロー

1. 右上の「データ取り込み」ボタンから CSV をアップロードします。
2. 文字コードを自動判定し、DuckDB (`app.duckdb`) に UPSERT します。
3. 現在のフィルタ条件でダッシュボードが即再描画され、トーストで結果を通知します。

## ディレクトリ構成

```
app.py                     # Streamlit エントリーポイント
services/
  data_loader.py           # CSV 読込・型変換・DuckDB 連携
  metrics.py               # KPI 算出・カードデータ生成
  aggregations.py          # 大分類平均 / 全体平均算出
  duckdb_store.py          # DuckDB UPSERT ラッパー
ui/
  components.py            # KPI カード・共通 UI コンポーネント
  charts.py                # Plotly 図生成
assets/
  styles.css               # 共通フォント・カードスタイル
tests/
  test_metrics.py          # KPI 計算のユニットテスト
requirements.txt
```

## テスト

```bash
pytest
```

`calculate_metrics` の分母ゼロ、欠損、減価償却費重複列などを検証するユニットテストを用意しています。
